<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keep-up | AI Habit & Task Tracker</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            orange: '#f97316',
                            dark: '#0f0f0f',
                            card: '#1a1a1a',
                            hover: '#2a2a2a'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Smooth theme transition */
        body {
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .smooth-transition {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-duration: 500ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f97316; 
        }
    </style>
</head>
<body class="bg-brand-dark text-gray-100 antialiased selection:bg-brand-orange selection:text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;

        // --- Global Config ---
        const DEFAULT_API_KEY = "AIzaSyAyAFTze3RJtXnY_vxbILqUdsGXkMBS-aY"; 

        // --- Mock Data & Helpers ---
        const MOCK_SUGGESTIONS = [
            "Prepare for AWS Cloud Practitioner exam",
            "Lose 5 kg in 2 months",
            "Build a personal portfolio website",
            "Learn Spanish in 30 days",
            "Read 12 books this year",
            "Master React & TypeScript",
            "Train for a half-marathon"
        ];

        const EXAMPLE_PLANS = [
            { emoji: "ðŸ’»", text: "Learn React in 30 days" },
            { emoji: "ðŸƒ", text: "Train for a 5k run" },
            { emoji: "ðŸ ", text: "Declutter my apartment" },
            { emoji: "ðŸ“š", text: "Read 3 books this month" }
        ];

        // --- GEMINI API INTEGRATION ---
        const callGeminiPlanGenerator = async (goal, timeframe, aiMode = 'general') => {
            const apiKey = localStorage.getItem('keepup_gemini_key') || DEFAULT_API_KEY;
            
            if (!apiKey) {
                console.warn("No API Key found. Using mock generator.");
                return mockAIPlanGenerator(goal, timeframe);
            }

            let systemInstruction = "";
            if (aiMode === 'spoon-fed') {
                systemInstruction = `
                    You are an expert productivity coach known for "spoon-feeding" success. 
                    Your task is to break down the user's goal into extremely granular, simple, and specific steps.
                    Do not give broad advice like "Study chapter 1". Instead say "Open the book to page 1 and read the first paragraph".
                    Focus on micro-actions that reduce friction.
                `;
            } else if (aiMode === 'concise') {
                systemInstruction = `
                    You are a no-nonsense, efficiency-focused project manager.
                    Create a brief, high-level plan with only the essential milestones.
                    Keep steps short, direct, and limited to the most critical actions. Avoid fluff.
                `;
            } else {
                // General
                systemInstruction = `
                    You are a balanced and helpful productivity coach.
                    Create a structured, well-rounded plan with clear, actionable steps.
                    Provide a good mix of high-level guidance and specific actions suitable for a general audience.
                `;
            }

            const prompt = `
                ${systemInstruction}
                
                Goal: "${goal}"
                Timeframe: "${timeframe || 'flexible'}"
                
                Create a plan.
                Return ONLY a valid JSON object with this schema:
                {
                    "category": "One of [Study, Work, Fitness, Health, Personal, General]",
                    "steps": [
                        { "title": "Step title", "estimatedTime": "e.g. 15m or 1h" }
                    ]
                }
                Do not include markdown code blocks. Just the JSON.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    console.warn("Gemini API Error Detail:", errData);
                    throw new Error(`API call failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                     throw new Error("Invalid API response format");
                }

                const aiResult = JSON.parse(data.candidates[0].content.parts[0].text);

                return {
                    id: Date.now(),
                    title: goal,
                    description: `AI generated plan (${aiMode === 'spoon-fed' ? 'Spoon-fed' : aiMode === 'concise' ? 'Concise' : 'General'} Mode) âœ¨`,
                    createdAt: new Date().toISOString(),
                    targetEndDate: timeframe ? new Date(Date.now() + 30*24*60*60*1000).toISOString() : null,
                    status: 'active',
                    progress: 0,
                    category: aiResult.category || "General",
                    subtasks: aiResult.steps.map((s, i) => ({
                        id: Date.now() + Math.random() + i,
                        title: s.title,
                        isDone: false,
                        estimatedTime: s.estimatedTime
                    }))
                };

            } catch (error) {
                console.error("Gemini Error:", error);
                const fallbackPlan = await mockAIPlanGenerator(goal, timeframe);
                fallbackPlan.description = "Plan generated (Offline Mode)";
                return fallbackPlan;
            }
        };

        // --- Contexts ---
        const ThemeContext = createContext();
        const AuthContext = createContext();
        const DataContext = createContext();

        // --- Simulated Backend Logic (Fallback) ---
        const mockAIPlanGenerator = async (goal, timeframe) => {
             return new Promise((resolve) => {
                setTimeout(() => {
                    const lowerGoal = goal.toLowerCase();
                    let steps = [];
                    let category = "General";

                    if (lowerGoal.includes("aws") || lowerGoal.includes("cloud") || lowerGoal.includes("azure") || lowerGoal.includes("certification")) {
                        category = "Study";
                        steps = [
                            "Review official exam guide and domains",
                            "Complete a comprehensive video course (e.g., Udemy/Coursera)",
                            "Read whitepapers (Well-Architected Framework)",
                            "Take practice exams to identify weak areas",
                            "Review incorrect practice answers",
                            "Hands-on labs: Spin up EC2, S3, RDS",
                            "Final revision of key services (IAM, VPC)"
                        ];
                    }
                    else if (lowerGoal.includes("learn") || lowerGoal.includes("study")) {
                        category = "Study";
                        steps = [
                            "Research best resources (courses, docs, books)",
                            "Create a structured study roadmap",
                            "Complete the fundamentals module",
                            "Build a 'Hello World' or starter project",
                            "Practice with coding challenges",
                            "Deep dive into advanced concepts",
                            "Build a capstone project to verify skills"
                        ];
                    } else if (lowerGoal.includes("build") || lowerGoal.includes("create") || lowerGoal.includes("develop")) {
                        category = "Work";
                        steps = [
                            "Define core requirements and MVP features",
                            "Sketch UI wireframes and database schema",
                            "Set up development environment & repo",
                            "Implement core backend/logic",
                            "Build frontend user interface",
                            "Perform testing and bug fixing",
                            "Deploy application to production"
                        ];
                    } else if (lowerGoal.includes("fitness") || lowerGoal.includes("lose") || lowerGoal.includes("run")) {
                        category = "Fitness";
                        steps = [
                            "Define specific fitness targets (weight, distance)",
                            "Create a weekly workout schedule",
                            "Plan healthy meals & grocery list",
                            "Complete Week 1 workouts",
                            "Track progress (weight/measurements)",
                            "Adjust intensity for Week 2",
                            "Review monthly progress and rest"
                        ];
                    } else {
                        category = "General";
                        steps = [
                            `Research and define scope for "${goal}"`,
                            "Break down main goal into milestones",
                            "Gather necessary tools and resources",
                            "Complete the first major milestone",
                            "Review progress and adjust timeline",
                            "Execute final phase of tasks",
                            "Final review and completion"
                        ];
                    }

                    const subtasks = steps.map((step, i) => ({
                        id: Date.now() + Math.random() + i,
                        title: step,
                        isDone: false,
                        estimatedTime: `${Math.floor(Math.random() * 2) + 1}h`
                    }));

                    resolve({
                        id: Date.now(),
                        title: goal,
                        description: `Plan generated (Offline Mode)`,
                        createdAt: new Date().toISOString(),
                        targetEndDate: timeframe ? new Date(Date.now() + 30*24*60*60*1000).toISOString() : null,
                        status: 'active',
                        progress: 0,
                        category: category,
                        subtasks: subtasks
                    });
                }, 1200);
            });
        };

        // --- Components ---

        // 1. Icons
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                sun: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
                moon: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
                layout: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
                user: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                logOut: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
                search: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
                checkCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m22 4-12 12-4-4"/></svg>,
                circle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/></svg>,
                trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
                edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
                arrowLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
                arrowRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
                refresh: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
                rotateCcw: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 8"/><path d="M3 3v5h5"/></svg>,
                sparkles: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
                settings: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
                x: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
                plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
                clock: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                check: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
                brain: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
                zap: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
                baby: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5"/><path d="M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.6 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.6A9 9 0 0 1 12 3c2 0 3.5 1.1 3.5 2.5s-.9 2.5-2 2.5c-.8 0-1.5-.4-1.5-1"/></svg>,
                camera: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
                image: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
                upload: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
                chevronRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
            };
            return icons[name] || null;
        };

        // 2. Custom Context Menu
        const CustomContextMenu = ({ x, y, onClose, onEdit, onDelete }) => {
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (menuRef.current && !menuRef.current.contains(e.target)) {
                        onClose();
                    }
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, [onClose]);

            return (
                <div 
                    ref={menuRef}
                    className="fixed z-50 bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700 rounded-lg shadow-2xl overflow-hidden min-w-[160px] py-1 animate-fade-in text-gray-800 dark:text-gray-200"
                    style={{ top: y, left: x }}
                >
                    <button 
                        onClick={onEdit}
                        className="w-full text-left px-4 py-3 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 transition-colors"
                    >
                        <Icon name="edit" size={14} /> Edit Task
                    </button>
                    <div className="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                    <button 
                        onClick={onDelete}
                        className="w-full text-left px-4 py-3 text-sm hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 dark:text-red-400 flex items-center gap-2 transition-colors"
                    >
                        <Icon name="trash" size={14} /> Delete Task
                    </button>
                </div>
            );
        };

        // 3. Smart Input
        const SmartInput = ({ onEnter }) => {
            const [inputValue, setInputValue] = useState("");
            const [suggestionIndex, setSuggestionIndex] = useState(0);
            const [tabPressCount, setTabPressCount] = useState(0);
            const [isFocused, setIsFocused] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [useAI, setUseAI] = useState(true);
            const inputRef = useRef(null);

            useEffect(() => {
                const interval = setInterval(() => {
                    setSuggestionIndex((prev) => (prev + 1) % MOCK_SUGGESTIONS.length);
                    if(!isFocused) setTabPressCount(0);
                }, 15000);
                return () => clearInterval(interval);
            }, [isFocused]);

            const handleSubmit = () => {
                if (inputValue.trim()) {
                    setIsLoading(true);
                    onEnter(inputValue, useAI).then(() => {
                        setIsLoading(false);
                        setInputValue("");
                        setTabPressCount(0);
                    });
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
                if (e.key === 'Tab') {
                    e.preventDefault(); 
                    if (inputValue.length > 0) return;
                    if (tabPressCount === 0) {
                        setTabPressCount(1);
                    } else {
                        setInputValue(MOCK_SUGGESTIONS[suggestionIndex]);
                        setTabPressCount(0);
                    }
                }
            };

            const activeSuggestion = MOCK_SUGGESTIONS[suggestionIndex];

            return (
                <div className="relative w-full max-w-2xl mx-auto mb-12 group z-10">
                    <div className={`absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none transition-colors duration-300 ${isFocused ? 'text-brand-orange' : 'text-gray-400 dark:text-gray-500'}`}>
                        <Icon name="search" size={24} />
                    </div>
                    
                    <input
                        ref={inputRef}
                        type="text"
                        value={inputValue}
                        onChange={(e) => { setInputValue(e.target.value); setTabPressCount(0); }}
                        onFocus={() => setIsFocused(true)}
                        onBlur={() => { setIsFocused(false); setTabPressCount(0); }}
                        onKeyDown={handleKeyDown}
                        disabled={isLoading}
                        id="smart-search-input" 
                        className="w-full pl-14 pr-24 py-5 bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700/50 rounded-2xl focus:ring-2 focus:ring-brand-orange focus:border-transparent outline-none text-lg transition-all shadow-xl placeholder-transparent smooth-transition text-gray-900 dark:text-gray-100"
                        placeholder="What is your main goal?"
                    />

                    {!inputValue && (
                        <div className={`absolute inset-y-0 left-14 py-5 pointer-events-none text-gray-400 dark:text-gray-500 truncate flex items-center transition-opacity duration-300 ${isFocused ? 'opacity-100' : 'opacity-70'}`}>
                            <span className="mr-3">{activeSuggestion}</span>
                            {isFocused && (
                                <span className={`text-[10px] px-1.5 py-0.5 rounded border border-gray-300 dark:border-gray-600 transition-colors ${tabPressCount === 1 ? 'bg-brand-orange text-white border-brand-orange' : 'bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400'}`}>
                                    {tabPressCount === 1 ? "Press Tab again" : "Tab"}
                                </span>
                            )}
                        </div>
                    )}

                    <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                        {isLoading ? (
                            <div className="w-5 h-5 border-2 border-brand-orange border-t-transparent rounded-full animate-spin mr-2"></div>
                        ) : (
                            inputValue.trim() && (
                                <div className="flex items-center gap-1 animate-fade-in bg-gray-100 dark:bg-gray-800/50 rounded-lg p-1 border border-gray-200 dark:border-gray-700/50">
                                    <button
                                        onClick={() => setUseAI(!useAI)}
                                        className={`p-1.5 rounded-md transition-all duration-300 ${
                                            useAI 
                                            ? 'bg-brand-orange text-white shadow-sm' 
                                            : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'
                                        }`}
                                        title={useAI ? "AI Generation Enabled" : "Enable AI Generation"}
                                    >
                                        <Icon name="sparkles" size={18} className={useAI ? "fill-white" : ""} />
                                    </button>
                                    <div className="w-px h-4 bg-gray-300 dark:bg-gray-700 mx-1"></div>
                                    <button 
                                        onClick={handleSubmit}
                                        className="p-1.5 text-brand-orange hover:bg-brand-orange/10 rounded-md transition-all"
                                    >
                                        <Icon name="arrowRight" size={20} />
                                    </button>
                                </div>
                            )
                        )}
                    </div>
                </div>
            );
        };

        // 4. Task Card
        const TaskCard = ({ task, onClick, onContextMenu }) => {
            const categoryColors = {
                "Study": "text-blue-500 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800",
                "Work": "text-purple-500 bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800",
                "Fitness": "text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800",
                "Health": "text-green-500 bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800",
                "Personal": "text-pink-500 bg-pink-50 dark:bg-pink-900/20 border-pink-200 dark:border-pink-800",
                "General": "text-gray-500 bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700"
            };

            const categoryStyle = categoryColors[task.category] || categoryColors["General"];

            return (
                <div 
                    onClick={onClick}
                    onContextMenu={onContextMenu}
                    className="group relative bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-800 rounded-2xl p-5 cursor-pointer hover:border-brand-orange/50 dark:hover:border-brand-orange/50 transition-all duration-300 shadow-sm hover:shadow-xl hover:shadow-brand-orange/5 hover:-translate-y-1 overflow-hidden flex flex-col justify-between h-full"
                >
                    <div className="absolute top-0 right-0 w-24 h-24 bg-brand-orange/10 rounded-full blur-2xl -mr-10 -mt-10 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>

                    <div className="relative z-10">
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex gap-2">
                                <span className={`text-[10px] font-bold tracking-wider uppercase px-2 py-1 rounded-md border ${
                                    task.progress === 100 
                                    ? 'bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 border-green-200 dark:border-green-900' 
                                    : 'bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-gray-700'
                                }`}>
                                    {task.progress === 100 ? 'Completed' : task.status}
                                </span>
                                <span className={`text-[10px] font-bold tracking-wider uppercase px-2 py-1 rounded-md border ${categoryStyle}`}>
                                    {task.category || "General"}
                                </span>
                            </div>
                            {task.targetEndDate && (
                                 <span className="text-[10px] text-gray-400 font-mono bg-gray-50 dark:bg-gray-800/50 px-1.5 py-0.5 rounded">
                                    Due {new Date(task.targetEndDate).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                 </span>
                            )}
                        </div>
                        
                        <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-1 leading-tight group-hover:text-brand-orange transition-colors">
                            {task.title}
                        </h3>
                        <p className="text-xs text-gray-500 dark:text-gray-400 line-clamp-2 mb-4">
                            {task.description}
                        </p>
                    </div>

                    <div className="relative z-10 mt-auto">
                        <div className="flex justify-between items-end mb-2">
                            <span className="text-[10px] font-medium text-gray-500 dark:text-gray-400 flex items-center gap-1.5">
                                 <Icon name="checkCircle" size={12} className={task.progress === 100 ? "text-green-500" : "text-gray-400"} />
                                 {task.subtasks.filter(s => s.isDone).length} / {task.subtasks.length} steps
                            </span>
                            <span className="text-xs font-bold text-brand-orange">
                                {task.progress}%
                            </span>
                        </div>
                        
                        <div className="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-1 overflow-hidden">
                            <div 
                                className="bg-brand-orange h-full rounded-full transition-all duration-1000 ease-out" 
                                style={{ width: `${task.progress}%` }}
                            ></div>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. XP/Level Badge
        const UserStats = () => {
            const { user } = useContext(AuthContext);
            if (!user) return null;

            const nextLevelXP = user.level * 100;
            const progress = (user.xp / nextLevelXP) * 100;

            return (
                <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-800 rounded-lg p-4 flex items-center gap-4 animate-fade-in smooth-transition shadow-sm">
                    <div className="relative">
                        <div className="w-12 h-12 rounded-full border-2 border-brand-orange flex items-center justify-center bg-gray-50 dark:bg-gray-800 text-brand-orange font-bold text-lg">
                            {user.level}
                        </div>
                        <div className="absolute -bottom-1 -right-1 bg-brand-orange text-black text-[10px] font-bold px-1.5 py-0.5 rounded-full">
                            LVL
                        </div>
                    </div>
                    <div className="flex-1">
                        <div className="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                            <span>{user.xp} XP</span>
                            <span>{nextLevelXP} XP</span>
                        </div>
                        <div className="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-1.5">
                            <div className="bg-brand-orange h-full rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
                        </div>
                        <div className="mt-1 text-xs text-gray-500">
                            {user.badges.length} Badges Earned
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Confirmation Modal
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, confirmText = "Confirm", isDanger = true }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform transition-all scale-100 animate-slide-up relative">
                        <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-2">{title}</h3>
                        <p className="text-gray-500 dark:text-gray-400 mb-6 text-sm leading-relaxed">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">Cancel</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className={`px-4 py-2 text-sm font-bold text-white rounded-lg shadow-lg transition-colors ${isDanger ? 'bg-red-500 hover:bg-red-600 shadow-red-500/20' : 'bg-brand-orange hover:bg-orange-600 shadow-orange-500/20'}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 7. Settings Modal
        const SettingsModal = ({ isOpen, onClose }) => {
            const [key, setKey] = useState("");
            useEffect(() => { if (isOpen) setKey(localStorage.getItem('keepup_gemini_key') || DEFAULT_API_KEY); }, [isOpen]);
            const handleSave = () => { localStorage.setItem('keepup_gemini_key', key.trim()); onClose(); };
            if (!isOpen) return null;
            return (
                 <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700 rounded-2xl p-6 max-w-md w-full shadow-2xl relative">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2"><Icon name="settings" size={20} className="text-brand-orange"/> Settings</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><Icon name="x" size={20} /></button>
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Google Gemini API Key</label>
                            <input type="password" value={key} onChange={(e) => setKey(e.target.value)} placeholder="AIzaSy..." className="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-brand-orange outline-none text-gray-900 dark:text-white"/>
                            <p className="text-xs text-gray-500 mt-2">Key stored locally. Default key active if empty.</p>
                        </div>
                        <div className="flex justify-end">
                            <button onClick={handleSave} className="px-4 py-2 bg-brand-orange text-white rounded-lg hover:bg-orange-600 font-medium">Save Settings</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 8. Auto-Reset Modal
        const AutoResetModal = ({ isOpen, onClose, task, onSave }) => {
            const [enabled, setEnabled] = useState(false);
            const [type, setType] = useState("daily");
            const [time, setTime] = useState("09:00");
            const [interval, setInterval] = useState(24);

            useEffect(() => {
                if (isOpen && task) {
                    const config = task.autoReset || {};
                    setEnabled(config.enabled || false);
                    setType(config.type || "daily");
                    setTime(config.time || "09:00");
                    setInterval(config.intervalHours || 24);
                }
            }, [isOpen, task]);

            const handleSave = () => {
                onSave({ enabled, type, time, intervalHours: Number(interval), lastReset: task.autoReset?.lastReset || new Date().toISOString() });
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl relative">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2"><Icon name="clock" size={20} className="text-brand-orange"/> Auto-Reset</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><Icon name="x" size={20} /></button>
                        </div>
                        <div className="space-y-6">
                            <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
                                <span className="font-medium text-gray-700 dark:text-gray-300">Enable Schedule</span>
                                <button onClick={() => setEnabled(!enabled)} className={`w-12 h-6 rounded-full transition-colors relative ${enabled ? 'bg-brand-orange' : 'bg-gray-300 dark:bg-gray-600'}`}>
                                    <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${enabled ? 'left-7' : 'left-1'}`}></div>
                                </button>
                            </div>
                            {enabled && (
                                <div className="space-y-4 animate-slide-up">
                                    <div className="flex gap-2 p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                        <button onClick={() => setType("daily")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${type === "daily" ? 'bg-white dark:bg-brand-card text-brand-orange shadow-sm' : 'text-gray-500 dark:text-gray-400'}`}>Daily</button>
                                        <button onClick={() => setType("interval")} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${type === "interval" ? 'bg-white dark:bg-brand-card text-brand-orange shadow-sm' : 'text-gray-500 dark:text-gray-400'}`}>Interval</button>
                                    </div>
                                    {type === "daily" ? (
                                        <div><label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Reset everyday at</label><input type="time" value={time} onChange={(e) => setTime(e.target.value)} className="w-full p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl outline-none focus:border-brand-orange text-gray-900 dark:text-white font-mono text-center"/></div>
                                    ) : (
                                        <div><label className="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Reset every</label><div className="flex items-center gap-3"><input type="number" min="1" max="720" value={interval} onChange={(e) => setInterval(e.target.value)} className="w-full p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl outline-none focus:border-brand-orange text-gray-900 dark:text-white font-mono text-center"/><span className="text-gray-500 dark:text-gray-400 font-medium">Hours</span></div></div>
                                    )}
                                </div>
                            )}
                            <button onClick={handleSave} className="w-full py-3 bg-brand-orange text-white rounded-xl hover:bg-orange-600 font-bold shadow-lg shadow-orange-500/20 transition-colors">Save Schedule</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 9. Toast
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`fixed bottom-6 right-6 px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up z-50 ${type === 'success' ? 'bg-white dark:bg-gray-800 border-l-4 border-green-500 text-gray-800 dark:text-white' : type === 'ai' ? 'bg-white dark:bg-gray-800 border-l-4 border-brand-orange text-gray-800 dark:text-white' : 'bg-white dark:bg-gray-800 border-l-4 border-gray-500 text-gray-800 dark:text-white'}`}>
                    <div className={type === 'success' ? 'text-green-500' : type === 'ai' ? 'text-brand-orange' : 'text-gray-500'}>
                        {type === 'success' ? <Icon name="check" size={20} /> : type === 'ai' ? <Icon name="sparkles" size={20} /> : <Icon name="settings" size={20} />}
                    </div>
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        // 10. Avatar Editor Modal
        const AvatarModal = ({ isOpen, onClose, onSave }) => {
            const [preview, setPreview] = useState(null);

            useEffect(() => {
                if (!isOpen) {
                    setPreview(null);
                }
            }, [isOpen]);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setPreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleConfirm = () => {
                if (preview) {
                    onSave(preview);
                    onClose();
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700 rounded-2xl p-6 max-w-md w-full shadow-2xl relative">
                         <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                <Icon name="camera" size={20} className="text-brand-orange"/> Change Avatar
                            </h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><Icon name="x" size={20} /></button>
                        </div>

                        {/* Content */}
                        <div className="flex flex-col items-center gap-6">
                            {/* Preview Area */}
                            <div className="w-32 h-32 rounded-full border-4 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 overflow-hidden flex items-center justify-center relative shadow-inner">
                                {preview ? (
                                    <img src={preview} alt="Preview" className="w-full h-full object-cover" />
                                ) : (
                                    <Icon name="image" size={32} className="text-gray-300 dark:text-gray-600" />
                                )}
                            </div>

                            {/* Controls */}
                            <div className="w-full">
                                <div className="relative">
                                    <input 
                                        type="file" 
                                        accept="image/*"
                                        onChange={handleFileUpload}
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    />
                                    <div className="w-full py-3 bg-gray-50 dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-center text-sm text-gray-500 dark:text-gray-400 hover:border-brand-orange hover:text-brand-orange transition-colors">
                                        Click to select image
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end mt-6">
                             <button 
                                onClick={handleConfirm}
                                disabled={!preview}
                                className="w-full py-3 bg-brand-orange text-white rounded-xl hover:bg-orange-600 font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-orange-500/20 transition-colors"
                            >
                                Save Avatar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 11. Google Account Modal
        const GoogleAccountModal = ({ isOpen, onClose, onSelect }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-slide-up relative">
                        {/* Google Header */}
                        <div className="p-6 pb-2 text-center relative">
                             <div className="flex justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                             </div>
                             <h3 className="text-xl font-medium text-gray-900">Choose an account</h3>
                             <p className="text-gray-600 text-sm mt-1">to continue to Keep-up</p>
                        </div>

                        {/* Account List */}
                        <div className="py-2">
                             <div 
                                onClick={() => onSelect({ name: "Alex Doe", email: "alex.doe@gmail.com" })}
                                className="flex items-center gap-4 px-6 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                             >
                                <div className="w-10 h-10 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-lg">A</div>
                                <div className="flex-1 text-left">
                                    <div className="font-medium text-gray-900">Alex Doe</div>
                                    <div className="text-sm text-gray-500">alex.doe@gmail.com</div>
                                </div>
                             </div>
                             
                             <div 
                                onClick={() => onSelect({ name: "Demo User", email: "demo@keepup.app" })}
                                className="flex items-center gap-4 px-6 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                             >
                                <div className="w-10 h-10 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold text-lg">D</div>
                                <div className="flex-1 text-left">
                                    <div className="font-medium text-gray-900">Demo User</div>
                                    <div className="text-sm text-gray-500">demo@keepup.app</div>
                                </div>
                             </div>

                             <div className="flex items-center gap-4 px-6 py-4 hover:bg-gray-100 cursor-pointer">
                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-gray-500">
                                    <Icon name="user" size={24} />
                                </div>
                                <div className="font-medium text-gray-800">Use another account</div>
                             </div>
                        </div>
                        
                        <div className="p-4 border-t border-gray-200 text-center">
                            <button onClick={onClose} className="text-sm text-gray-600 hover:text-gray-900">Cancel</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Navbar ---
        const Navbar = ({ onNavigate }) => {
            const { user, logout } = useContext(AuthContext);
            const { isDark, toggleTheme } = useContext(ThemeContext);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [imgError, setImgError] = useState(false);

            if (!user) return null;

            return (
                <nav className="sticky top-0 z-40 bg-white/80 dark:bg-brand-dark/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 transition-colors duration-500">
                    <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => onNavigate('dashboard')}>
                            {/* FIXED: Using Verified Image Source & Error Handling */}
                            {!imgError ? (
                                <img 
                                    src="image_2f2a6d.png" 
                                    alt="Keep-up Logo" 
                                    className="w-8 h-8 object-contain rounded-lg"
                                    onError={() => setImgError(true)} 
                                />
                            ) : (
                                <div className="w-8 h-8 bg-brand-orange rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-brand-orange/30">K</div>
                            )}
                            <span className="text-xl font-bold tracking-tight text-gray-900 dark:text-white">Keep-up</span>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="hidden md:flex items-center gap-6 text-sm font-medium text-gray-500 dark:text-gray-400">
                                <button onClick={() => onNavigate('dashboard')} className="hover:text-brand-orange transition-colors flex items-center gap-2 text-gray-900 dark:text-white"><Icon name="layout" size={18} /> Dashboard</button>
                                <button onClick={() => onNavigate('profile')} className="hover:text-brand-orange transition-colors flex items-center gap-2"><Icon name="user" size={18} /> Profile</button>
                            </div>
                            <div className="h-6 w-px bg-gray-200 dark:bg-gray-700 hidden md:block"></div>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400 hover:text-brand-orange transition-colors"><Icon name="settings" size={18} /></button>
                            <button onClick={toggleTheme} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400 hover:text-brand-orange transition-colors">{isDark ? <Icon name="sun" size={18} /> : <Icon name="moon" size={18} />}</button>
                            <button onClick={logout} className="flex items-center gap-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition-colors"><Icon name="logOut" size={18} /> <span className="hidden md:inline">Sign Out</span></button>
                        </div>
                    </div>
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} />
                </nav>
            );
        };

        // --- Landing Page ---
        const LandingPage = ({ onGetStarted }) => {
            const [imgError, setImgError] = useState(false);

            return (
                // FIXED: Changed dark:bg-brand-dark to dark:bg-transparent so the global lights show through
                <div className="min-h-screen bg-gray-50 dark:bg-transparent text-gray-900 dark:text-white overflow-hidden relative transition-colors duration-500">
                    <div className="relative z-10 flex flex-col items-center justify-center min-h-screen text-center px-6">
                        <div className="mb-8 relative group flex justify-center items-center">
                             <div className="absolute inset-0 bg-brand-orange/40 rounded-full blur-3xl opacity-20 group-hover:opacity-40 transition-opacity duration-500"></div>
                             {/* FIXED: Using Verified Image Source & Error Handling */}
                             {!imgError ? (
                                <img 
                                    src="image_2f2a6d.png" 
                                    alt="Logo" 
                                    className="w-24 h-24 object-contain rounded-2xl shadow-2xl relative z-10 bg-white/10 backdrop-blur-sm p-2" 
                                    onError={() => setImgError(true)} 
                                />
                             ) : (
                                <div className="w-24 h-24 bg-brand-orange rounded-2xl flex items-center justify-center text-white font-bold text-5xl shadow-2xl relative z-10">K</div>
                             )}
                        </div>
                        <h1 className="text-5xl md:text-7xl font-bold tracking-tight mb-6 leading-tight">Master your <span className="text-transparent bg-clip-text bg-gradient-to-r from-brand-orange to-orange-400">habits.</span> <br />Crush your goals.</h1>
                        <p className="text-lg md:text-xl text-gray-500 dark:text-gray-400 max-w-2xl mb-10 leading-relaxed">The AI-powered productivity tool that turns your vague goals into actionable, spoon-fed plans. Stop planning, start doing.</p>
                        <button onClick={onGetStarted} className="group relative px-8 py-4 bg-brand-orange text-white rounded-full font-bold text-lg shadow-xl shadow-orange-500/30 hover:bg-orange-600 hover:shadow-orange-500/50 hover:-translate-y-1 transition-all duration-300">Get Started Free<Icon name="arrowRight" className="inline-block ml-2 group-hover:translate-x-1 transition-transform" /></button>
                        <div className="mt-20 flex flex-wrap justify-center gap-4 opacity-80">
                            <div className="flex items-center gap-2 px-4 py-2 bg-white/50 dark:bg-white/5 backdrop-blur-md rounded-full border border-gray-200 dark:border-white/10 text-sm"><Icon name="sparkles" size={16} className="text-brand-orange" /> AI Planning</div>
                            <div className="flex items-center gap-2 px-4 py-2 bg-white/50 dark:bg-white/5 backdrop-blur-md rounded-full border border-gray-200 dark:border-white/10 text-sm"><Icon name="check" size={16} className="text-green-500" /> Habit Tracking</div>
                            <div className="flex items-center gap-2 px-4 py-2 bg-white/50 dark:bg-white/5 backdrop-blur-md rounded-full border border-gray-200 dark:border-white/10 text-sm"><Icon name="zap" size={16} className="text-yellow-500" /> Gamification</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Login Page ---
        const Login = ({ onLoginSuccess, onSwitchToGuest }) => {
            const { isDark, toggleTheme } = useContext(ThemeContext);
            const [isSignup, setIsSignup] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [showGoogleModal, setShowGoogleModal] = useState(false);
            const [imgError, setImgError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!email || !password) {
                    setError("Please enter both email and password.");
                    setTimeout(() => setError(""), 2000);
                    return;
                }
                onLoginSuccess("email");
            };

            const handleGoogleClick = () => {
                setShowGoogleModal(true);
            };

            const handleGoogleSelect = (account) => {
                setShowGoogleModal(false);
                onLoginSuccess("google", account);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden bg-gray-100 dark:bg-transparent transition-colors duration-500">
                    <div className="absolute top-[-20%] left-[-10%] w-[500px] h-[500px] bg-brand-orange/10 rounded-full blur-[120px]"></div>
                    
                    <div className="w-full max-w-md bg-white dark:bg-brand-card/90 backdrop-blur-sm border border-gray-200 dark:border-gray-800 p-8 rounded-2xl shadow-2xl relative z-10 animate-fade-in transition-colors duration-500">
                        <div className="flex justify-center mb-8">
                            <div className="w-16 h-16 flex items-center justify-center group cursor-pointer hover:scale-105 transition-transform">
                                {/* FIXED: Using Verified Image Source & Error Handling */}
                                 {!imgError ? (
                                     <img 
                                        src="image_2f2a6d.png" 
                                        alt="Keep-up Logo" 
                                        className="w-full h-full object-contain drop-shadow-lg"
                                        onError={() => setImgError(true)} 
                                    />
                                 ) : (
                                    <div className="w-12 h-12 bg-brand-orange rounded-xl flex items-center justify-center text-white font-bold text-2xl shadow-lg shadow-brand-orange/20">K</div>
                                 )}
                            </div>
                        </div>
                        
                        <h2 className="text-3xl font-bold text-center mb-2 text-gray-900 dark:text-white">
                            {isSignup ? "Create Account" : "Welcome Back"}
                        </h2>
                        <p className="text-center text-gray-500 dark:text-gray-400 mb-8">
                            {isSignup ? "Start your productivity journey today." : "Continue where you left off."}
                        </p>

                        <div className="space-y-4">
                            <button 
                                onClick={handleGoogleClick}
                                className="w-full py-3 px-4 bg-white border border-gray-200 hover:border-gray-300 text-gray-900 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-2 shadow-sm"
                            >
                                <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                Continue with Google
                            </button>
                            
                            <div className="relative flex py-2 items-center">
                                <div className="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                                <span className="flex-shrink mx-4 text-gray-500 text-sm">Or</span>
                                <div className="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <input 
                                        type="email" 
                                        placeholder="Email address" 
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className={`w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border ${error ? 'border-red-500' : 'border-gray-200 dark:border-gray-700'} rounded-lg focus:ring-2 focus:ring-brand-orange outline-none text-gray-900 dark:text-white placeholder-gray-500 transition-colors`} 
                                    />
                                </div>
                                <div>
                                    <input 
                                        type="password" 
                                        placeholder="Password" 
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className={`w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border ${error ? 'border-red-500' : 'border-gray-200 dark:border-gray-700'} rounded-lg focus:ring-2 focus:ring-brand-orange outline-none text-gray-900 dark:text-white placeholder-gray-500 transition-colors`} 
                                    />
                                    {error && <p className="text-red-500 text-xs mt-1 animate-shake">{error}</p>}
                                </div>

                                <button 
                                    type="submit" 
                                    className="w-full py-3 px-4 bg-brand-orange hover:bg-orange-600 text-white font-bold rounded-lg transition-colors shadow-lg shadow-orange-500/20"
                                >
                                    {isSignup ? "Create Account" : "Sign In"}
                                </button>
                            </form>
                            
                            <div className="flex justify-between items-center text-sm pt-2">
                                <button onClick={() => { setIsSignup(!isSignup); setError(""); }} className="text-brand-orange hover:underline font-medium">
                                    {isSignup ? "Already have an account?" : "Create an account"}
                                </button>
                                <button onClick={() => onSwitchToGuest()} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                                    Guest Mode
                                </button>
                            </div>
                        </div>
                        
                        <div className="mt-8 flex justify-center items-center gap-4">
                            <span className="text-sm text-gray-500">Theme</span>
                            <button onClick={toggleTheme} className="p-2 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400 hover:text-brand-orange transition-colors">
                                {isDark ? <Icon name="sun" size={18} /> : <Icon name="moon" size={18} />}
                            </button>
                        </div>
                    </div>
                    
                    <GoogleAccountModal isOpen={showGoogleModal} onClose={() => setShowGoogleModal(false)} onSelect={(account) => { setShowGoogleModal(false); onLoginSuccess("google", account); }} />
                </div>
            );
        };

        // --- Pages ---

        const Profile = ({ onBack }) => {
            const { user, updateUser } = useContext(AuthContext);
            const { isDark, toggleTheme } = useContext(ThemeContext);
            const [showAvatarModal, setShowAvatarModal] = useState(false);

            if (!user) return null;

            const handleAiModeChange = (mode) => {
                updateUser({ ...user, aiMode: mode });
            };

            const handleSaveAvatar = (newAvatar) => {
                updateUser({ ...user, avatar: newAvatar });
            };

            return (
                <div className="max-w-4xl mx-auto py-10 px-6 animate-fade-in">
                    <button onClick={onBack} className="flex items-center gap-2 text-gray-500 hover:text-brand-orange transition-colors mb-8 group">
                        <Icon name="arrowLeft" className="group-hover:-translate-x-1 transition-transform" /> Back to Dashboard
                    </button>

                    <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-800 rounded-2xl p-8 shadow-xl mb-8 flex flex-col md:flex-row items-center md:items-start gap-8 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-brand-orange/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        
                        <div className="relative group cursor-pointer" onClick={() => setShowAvatarModal(true)}>
                            <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-white dark:border-gray-800 shadow-lg shadow-brand-orange/20 relative z-10 bg-gradient-to-br from-brand-orange to-orange-600 flex items-center justify-center">
                                {user.avatar ? (
                                    <img src={user.avatar} alt="Profile" className="w-full h-full object-cover" />
                                ) : (
                                    <span className="text-white text-4xl font-bold">{user.name.charAt(0)}</span>
                                )}
                            </div>
                            {/* Hover Overlay for Edit */}
                            <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                <Icon name="camera" size={24} className="text-white" />
                            </div>
                        </div>

                        <div className="flex-1 text-center md:text-left relative z-10">
                            <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">{user.name}</h2>
                            <div className="flex items-center justify-center md:justify-start gap-2 mb-6">
                                <span className="px-3 py-1 bg-brand-orange/10 text-brand-orange text-xs font-bold uppercase tracking-wider rounded-full border border-brand-orange/20">Level {user.level}</span>
                                <span className="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-xs font-bold uppercase tracking-wider rounded-full border border-gray-200 dark:border-gray-700">{user.type === 'guest' ? 'Guest Account' : 'Member'}</span>
                            </div>
                            
                            <div className="flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
                                <div className="bg-gray-50 dark:bg-gray-800/50 px-6 py-4 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col items-center md:items-start min-w-[120px]">
                                    <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Total XP</div>
                                    <div className="text-2xl font-bold text-gray-900 dark:text-white">{user.xp}</div>
                                </div>
                                <div className="bg-gray-50 dark:bg-gray-800/50 px-6 py-4 rounded-xl border border-gray-200 dark:border-gray-700 flex flex-col items-center md:items-start min-w-[120px]">
                                    <div className="text-xs text-gray-500 uppercase tracking-wider mb-1">Badges</div>
                                    <div className="text-2xl font-bold text-gray-900 dark:text-white">{user.badges?.length || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-6">AI Preferences</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <button 
                            onClick={() => handleAiModeChange('spoon-fed')}
                            className={`p-5 rounded-xl border transition-all text-left flex flex-col gap-3 relative overflow-hidden group ${user.aiMode === 'spoon-fed' ? 'bg-brand-orange text-white border-brand-orange shadow-lg shadow-brand-orange/30' : 'bg-white dark:bg-brand-card border-gray-200 dark:border-gray-800 hover:border-brand-orange/50'}`}
                        >
                            <div className={`p-2 rounded-lg w-fit ${user.aiMode === 'spoon-fed' ? 'bg-white/20' : 'bg-gray-100 dark:bg-gray-800 text-brand-orange'}`}>
                                <Icon name="baby" size={24} />
                            </div>
                            <div>
                                <h4 className={`font-bold mb-1 ${user.aiMode === 'spoon-fed' ? 'text-white' : 'text-gray-900 dark:text-white'}`}>Spoon-fed Mode</h4>
                                <p className={`text-xs ${user.aiMode === 'spoon-fed' ? 'text-white/80' : 'text-gray-500 dark:text-gray-400'}`}>Granular, baby steps for when you're stuck.</p>
                            </div>
                        </button>

                        <button 
                            onClick={() => handleAiModeChange('general')}
                            className={`p-5 rounded-xl border transition-all text-left flex flex-col gap-3 relative overflow-hidden group ${user.aiMode === 'general' || !user.aiMode ? 'bg-brand-orange text-white border-brand-orange shadow-lg shadow-brand-orange/30' : 'bg-white dark:bg-brand-card border-gray-200 dark:border-gray-800 hover:border-brand-orange/50'}`}
                        >
                            <div className={`p-2 rounded-lg w-fit ${user.aiMode === 'general' || !user.aiMode ? 'bg-white/20' : 'bg-gray-100 dark:bg-gray-800 text-brand-orange'}`}>
                                <Icon name="brain" size={24} />
                            </div>
                            <div>
                                <h4 className={`font-bold mb-1 ${user.aiMode === 'general' || !user.aiMode ? 'text-white' : 'text-gray-900 dark:text-white'}`}>General Mode</h4>
                                <p className={`text-xs ${user.aiMode === 'general' || !user.aiMode ? 'text-white/80' : 'text-gray-500 dark:text-gray-400'}`}>Balanced, standard breakdown of tasks.</p>
                            </div>
                        </button>

                        <button 
                            onClick={() => handleAiModeChange('concise')}
                            className={`p-5 rounded-xl border transition-all text-left flex flex-col gap-3 relative overflow-hidden group ${user.aiMode === 'concise' ? 'bg-brand-orange text-white border-brand-orange shadow-lg shadow-brand-orange/30' : 'bg-white dark:bg-brand-card border-gray-200 dark:border-gray-800 hover:border-brand-orange/50'}`}
                        >
                            <div className={`p-2 rounded-lg w-fit ${user.aiMode === 'concise' ? 'bg-white/20' : 'bg-gray-100 dark:bg-gray-800 text-brand-orange'}`}>
                                <Icon name="zap" size={24} />
                            </div>
                            <div>
                                <h4 className={`font-bold mb-1 ${user.aiMode === 'concise' ? 'text-white' : 'text-gray-900 dark:text-white'}`}>Concise Mode</h4>
                                <p className={`text-xs ${user.aiMode === 'concise' ? 'text-white/80' : 'text-gray-500 dark:text-gray-400'}`}>High-level milestones for quick planning.</p>
                            </div>
                        </button>
                    </div>

                    <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-6">Preferences</h3>
                    <div className="grid grid-cols-1 gap-4">
                        <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-800 rounded-xl p-6 flex items-center justify-between hover:border-brand-orange/30 transition-all shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-gray-100 dark:bg-gray-800 rounded-xl text-gray-600 dark:text-gray-300">
                                    {isDark ? <Icon name="moon" size={24} /> : <Icon name="sun" size={24} />}
                                </div>
                                <div>
                                    <h4 className="font-semibold text-gray-900 dark:text-white">Appearance</h4>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">Toggle between light and dark themes</p>
                                </div>
                            </div>
                            <button onClick={toggleTheme} className="px-4 py-2 text-sm font-bold bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors border border-gray-200 dark:border-gray-700">
                                {isDark ? 'Switch to Light' : 'Switch to Dark'}
                            </button>
                        </div>
                    </div>
                    
                    <AvatarModal 
                        isOpen={showAvatarModal} 
                        onClose={() => setShowAvatarModal(false)} 
                        onSave={handleSaveAvatar} 
                    />
                </div>
            );
        };

        const Dashboard = ({ onTaskSelect }) => {
            const { tasks, addTask, deleteTask } = useContext(DataContext);
            const { user } = useContext(AuthContext);
            const [contextMenu, setContextMenu] = useState(null);
            const [activeFilter, setActiveFilter] = useState("All");
            const CATEGORIES = ["All", "Study", "Work", "Fitness", "Health", "Personal", "General"];
            const filteredTasks = activeFilter === "All" ? tasks : tasks.filter(t => (t.category || "General") === activeFilter);

            const handleCreate = async (goal, useAI = false) => {
                const goalText = typeof goal === 'string' ? goal : "";
                if (!goalText) return;
                if (useAI) {
                    const plan = await callGeminiPlanGenerator(goalText, "1 month", user.aiMode || 'general');
                    addTask(plan);
                } else {
                    const newTask = { id: Date.now(), title: goalText, description: "Manual task", createdAt: new Date().toISOString(), targetEndDate: null, status: 'active', progress: 0, category: "General", subtasks: [] };
                    await new Promise(r => setTimeout(r, 400));
                    addTask(newTask);
                }
            };

            const handleContextMenu = (e, task) => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, taskId: task.id }); };
            const handleDelete = () => { if (contextMenu) { deleteTask(contextMenu.taskId); setContextMenu(null); } };

            return (
                <div className="max-w-5xl mx-auto py-10 px-6">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-12 gap-6">
                        <div>
                            <h1 className="text-4xl md:text-5xl font-bold mb-3 tracking-tight smooth-transition text-gray-900 dark:text-white">Stay focused, <br/><span className="text-brand-orange">Keep-up.</span></h1>
                            <p className="text-gray-500 text-lg max-w-lg">AI-powered productivity to turn your chaos into structured progress.</p>
                        </div>
                        <div className="w-full md:w-auto min-w-[250px]"><UserStats /></div>
                    </div>
                    <SmartInput onEnter={handleCreate} />
                    {tasks.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-10 animate-fade-in">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800/50 mb-4 text-gray-400 dark:text-gray-500"><Icon name="search" size={28} /></div>
                            <h3 className="text-lg font-medium text-gray-900 dark:text-gray-200 mb-2">No active tasks</h3>
                            <p className="text-gray-500 dark:text-gray-400 max-w-sm mx-auto text-center mb-8">Ready to start? Type a goal above or try one of these:</p>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-lg">
                                {EXAMPLE_PLANS.map((plan, idx) => (
                                    <button key={idx} onClick={() => handleCreate(plan.text, true)} className="flex items-center gap-3 p-3 text-left bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl hover:border-brand-orange/50 dark:hover:border-brand-orange/50 hover:shadow-lg transition-all group">
                                        <span className="text-xl group-hover:scale-110 transition-transform">{plan.emoji}</span>
                                        <span className="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-brand-orange transition-colors">{plan.text}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="animate-fade-in">
                            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                                <h2 className="text-xl font-semibold text-gray-900 dark:text-white">Your tasks</h2>
                                <div className="flex gap-2 overflow-x-auto pb-2 sm:pb-0 scrollbar-hide -mx-6 px-6 sm:mx-0 sm:px-0">
                                    {CATEGORIES.map(cat => (
                                        <button key={cat} onClick={() => setActiveFilter(cat)} className={`px-3 py-1.5 rounded-full text-xs font-medium transition-all whitespace-nowrap border ${activeFilter === cat ? 'bg-brand-orange border-brand-orange text-white shadow-lg shadow-brand-orange/20' : 'bg-white dark:bg-brand-card text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'}`}>{cat}</button>
                                    ))}
                                </div>
                            </div>
                            {filteredTasks.length === 0 ? (
                                <div className="text-center py-20 border border-dashed border-gray-200 dark:border-gray-800 rounded-2xl bg-gray-50 dark:bg-brand-card/30">
                                    <p className="text-gray-500 dark:text-gray-400">No tasks found in "{activeFilter}"</p>
                                    <button onClick={() => setActiveFilter("All")} className="text-brand-orange text-sm font-medium mt-2 hover:underline">Show all tasks</button>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredTasks.map(task => (<TaskCard key={task.id} task={task} onClick={() => onTaskSelect(task)} onContextMenu={(e) => handleContextMenu(e, task)} />))}
                                </div>
                            )}
                        </div>
                    )}
                    {contextMenu && <CustomContextMenu x={contextMenu.x} y={contextMenu.y} onClose={() => setContextMenu(null)} onEdit={() => { alert("Edit feature coming in v2"); setContextMenu(null); }} onDelete={handleDelete} />}
                </div>
            );
        };

        const TaskDetail = ({ task, onBack }) => {
            const { updateTaskSubtask, resetTask, regenerateTask, deleteTaskSubtask, editTaskSubtask, addTaskSubtask, updateTaskAutoReset, updateSubtaskTip } = useContext(DataContext);
            const { user, addXP } = useContext(AuthContext);
            const [isRegenerating, setIsRegenerating] = useState(false);
            const [showResetModal, setShowResetModal] = useState(false);
            const [showRegenerateModal, setShowRegenerateModal] = useState(false);
            const [showAutoResetModal, setShowAutoResetModal] = useState(false);
            const [isAddingStep, setIsAddingStep] = useState(false);
            const [newStepText, setNewStepText] = useState("");
            const [editingSubtaskId, setEditingSubtaskId] = useState(null);
            const [editingText, setEditingText] = useState("");
            const [stepToDelete, setStepToDelete] = useState(null);
            
            const addStepInputRef = useRef(null);
            const editInputRef = useRef(null);
            const listEndRef = useRef(null);

            useEffect(() => { if (isAddingStep) { if(addStepInputRef.current) addStepInputRef.current.focus(); if(listEndRef.current) listEndRef.current.scrollIntoView({ behavior: 'smooth' }); } }, [isAddingStep]);
            useEffect(() => { if (editingSubtaskId && editInputRef.current) editInputRef.current.focus(); }, [editingSubtaskId]);

            if (!task) return null;

            const handleToggle = (subtaskId, currentStatus) => { const newStatus = !currentStatus; updateTaskSubtask(task.id, subtaskId, newStatus); if (newStatus) addXP(10); else addXP(-10); };
            const confirmDeleteSubtask = () => { if (stepToDelete) { deleteTaskSubtask(task.id, stepToDelete); setStepToDelete(null); } };
            const startEditing = (sub) => { setEditingSubtaskId(sub.id); setEditingText(sub.title); };
            const saveEdit = (subId) => { if (editingText.trim()) { editTaskSubtask(task.id, subId, editingText.trim()); setEditingSubtaskId(null); setEditingText(""); } };
            const cancelEdit = () => { setEditingSubtaskId(null); setEditingText(""); };
            const handleConfirmAddStep = () => { if (newStepText.trim()) { addTaskSubtask(task.id, newStepText.trim()); setNewStepText(""); if(addStepInputRef.current) addStepInputRef.current.focus(); } else { setIsAddingStep(false); } };
            const handleCancelAddStep = () => { setIsAddingStep(false); setNewStepText(""); };
            const handleResetClick = () => { setShowResetModal(true); };
            const confirmReset = () => { resetTask(task.id); };
            const handleRegenerateClick = () => { setShowRegenerateModal(true); };
            const confirmRegenerate = async () => { setIsRegenerating(true); const newPlan = await callGeminiPlanGenerator(task.title, "1 month", user.aiMode || 'general'); regenerateTask(task.id, newPlan.subtasks, newPlan.description); setIsRegenerating(false); };
            const handleAutoResetSave = (config) => { updateTaskAutoReset(task.id, config); };

            return (
                <div className="max-w-4xl mx-auto py-10 px-6 animate-fade-in pb-24">
                    <button onClick={onBack} className="flex items-center gap-2 text-gray-500 hover:text-brand-orange transition-colors mb-8 group"><Icon name="arrowLeft" className="group-hover:-translate-x-1 transition-transform" /> Back to Dashboard</button>
                    <div className="flex flex-col md:flex-row justify-between items-start gap-4 mb-8">
                        <div>
                            <div className="flex gap-2 mb-3">
                                <div className="inline-flex items-center gap-1.5 px-2.5 py-1 bg-brand-orange/10 text-brand-orange text-xs font-medium rounded-full border border-brand-orange/20">{task.description.includes("AI") || task.description.includes("Gemini") ? "âœ¨ AI Plan" : "ðŸ“ Manual Task"}</div>
                                {task.autoReset?.enabled && <div className="inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-500/10 text-blue-500 text-xs font-medium rounded-full border border-blue-500/20"><Icon name="clock" size={10} />{task.autoReset.type === 'daily' ? `Daily ${task.autoReset.time}` : `Every ${task.autoReset.intervalHours}h`}</div>}
                            </div>
                            <h1 className="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100">{task.title}</h1>
                            <p className="text-gray-500 mt-2">{task.description}</p>
                        </div>
                        <div className="flex flex-col items-end gap-3">
                             <div className="flex gap-2">
                                <button onClick={handleRegenerateClick} disabled={isRegenerating} className={`flex items-center gap-2 px-4 py-2 border border-brand-orange/30 bg-brand-orange/10 hover:bg-brand-orange/20 rounded-lg transition-colors text-sm font-semibold text-brand-orange shadow-sm hover:shadow-brand-orange/10 ${isRegenerating ? 'opacity-50 cursor-wait' : ''}`}><Icon name="sparkles" size={14} /> {isRegenerating ? 'Designing Plan...' : 'Regenerate'}</button>
                             </div>
                             <div className="flex gap-2">
                                <button onClick={handleResetClick} className="flex items-center gap-2 px-4 py-2 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"><Icon name="rotateCcw" size={14} /> Reset</button>
                                <button onClick={() => setShowAutoResetModal(true)} className={`flex items-center justify-center px-3 py-2 border rounded-lg transition-colors ${task.autoReset?.enabled ? 'border-blue-500/30 bg-blue-500/10 text-blue-500 hover:bg-blue-500/20' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400'}`} title="Auto-Reset Settings"><Icon name="clock" size={16} /></button>
                             </div>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-800 p-6 rounded-xl mb-10 shadow-xl">
                        <div className="flex justify-between items-end mb-2"><span className="font-medium text-gray-600 dark:text-gray-300">Total Progress</span><span className="text-2xl font-bold text-brand-orange">{task.progress}%</span></div>
                        <div className="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-3 mb-4"><div className="bg-brand-orange h-3 rounded-full transition-all duration-700" style={{ width: `${task.progress}%` }}></div></div>
                        <div className="flex justify-between text-xs text-gray-500"><span>Started: {new Date(task.createdAt).toLocaleDateString()}</span><span>Target: {task.targetEndDate ? new Date(task.targetEndDate).toLocaleDateString() : 'No Deadline'}</span></div>
                    </div>
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-200">Your Action Plan</h3>
                        <button onClick={() => setIsAddingStep(true)} className="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm font-medium text-gray-600 dark:text-gray-300 hover:border-brand-orange hover:text-brand-orange transition-all"><Icon name="plus" size={14} /> Add Step</button>
                    </div>
                    {task.subtasks.length === 0 && !isAddingStep ? (
                        <div className="text-center py-10 border-2 border-dashed border-gray-200 dark:border-gray-800 rounded-xl mb-6"><p className="text-gray-500">No steps yet. Add one or regenerate the plan.</p></div>
                    ) : (
                        <div className="space-y-3 mb-6">
                            {task.subtasks.map((sub, idx) => (
                                <div key={sub.id} className="flex flex-col gap-2">
                                    <div onClick={() => editingSubtaskId !== sub.id && handleToggle(sub.id, sub.isDone)} className={`group flex items-center justify-between p-4 rounded-xl border transition-all duration-300 ${editingSubtaskId === sub.id ? 'bg-brand-orange/5 border-brand-orange ring-1 ring-brand-orange' : sub.isDone ? 'bg-gray-100 dark:bg-brand-dark/30 border-gray-200 dark:border-gray-800/50 opacity-60 cursor-pointer' : 'bg-white dark:bg-brand-card border-gray-200 dark:border-gray-700 hover:border-brand-orange/30 dark:hover:border-brand-orange/30 shadow-sm hover:shadow-md cursor-pointer'}`} style={{ animationDelay: `${idx * 50}ms` }}>
                                        {editingSubtaskId === sub.id ? (
                                            <div className="flex items-center gap-3 w-full" onClick={(e) => e.stopPropagation()}>
                                                <div className="text-brand-orange"><Icon name="edit" size={20} /></div>
                                                <input ref={editInputRef} type="text" value={editingText} onChange={(e) => setEditingText(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') saveEdit(sub.id); if(e.key === 'Escape') cancelEdit(); }} className="flex-1 bg-transparent outline-none text-gray-900 dark:text-white" />
                                                <button onClick={() => saveEdit(sub.id)} className="p-1 text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 rounded"><Icon name="checkCircle" size={18} /></button>
                                                <button onClick={cancelEdit} className="p-1 text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded"><Icon name="x" size={18} /></button>
                                            </div>
                                        ) : (
                                            <>
                                                <div className="flex items-center gap-4 flex-1">
                                                    <button className={`p-1 rounded-full transition-colors ${sub.isDone ? 'text-brand-orange' : 'text-gray-400 dark:text-gray-500 group-hover:text-brand-orange'}`}>{sub.isDone ? <Icon name="checkCircle" size={24} /> : <Icon name="circle" size={24} />}</button>
                                                    <span className={`text-sm md:text-base select-none ${sub.isDone ? 'line-through text-gray-500' : 'text-gray-700 dark:text-gray-200'}`}>{sub.title}</span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="hidden sm:inline-block text-xs font-mono text-gray-500 bg-gray-100 dark:bg-gray-800/50 px-2 py-1 rounded whitespace-nowrap border border-gray-200 dark:border-gray-700/50">{sub.estimatedTime || "30m"}</span>
                                                    <div className="flex items-center gap-1 border-l border-gray-200 dark:border-gray-700 pl-2 relative z-10" onClick={(e) => e.stopPropagation()}>
                                                        <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); startEditing(sub); }} onMouseDown={(e) => e.stopPropagation()} className="p-2 text-gray-400 hover:text-brand-orange hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md transition-colors" title="Edit step"><Icon name="edit" size={16} /></button>
                                                        <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); setStepToDelete(sub.id); }} onMouseDown={(e) => e.stopPropagation()} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors" title="Delete step"><Icon name="trash" size={16} /></button>
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {isAddingStep && (
                        <div className="flex items-center gap-4 p-4 rounded-xl border border-brand-orange/50 bg-brand-orange/5 animate-fade-in shadow-sm mb-4">
                            <div className="text-brand-orange"><Icon name="circle" size={24} /></div>
                            <input ref={addStepInputRef} type="text" value={newStepText} onChange={(e) => setNewStepText(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') handleConfirmAddStep(); if(e.key === 'Escape') handleCancelAddStep(); }} placeholder="Type your next step here..." className="flex-1 bg-transparent outline-none text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 text-sm md:text-base" />
                            <div className="flex items-center gap-2">
                                <button onClick={handleConfirmAddStep} className="p-2 bg-brand-orange text-white rounded-lg hover:bg-orange-600 transition-colors shadow-sm"><Icon name="arrowRight" size={16} /></button>
                                <button onClick={handleCancelAddStep} className="p-2 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors"><Icon name="x" size={16} /></button>
                            </div>
                        </div>
                    )}
                    <div ref={listEndRef} />
                    <ConfirmationModal isOpen={showResetModal} onClose={() => setShowResetModal(false)} onConfirm={confirmReset} title="Reset Progress?" message="This will uncheck all subtasks and remove completion timestamps. Are you sure?" confirmText="Yes, Reset" isDanger={true} />
                    <ConfirmationModal isOpen={showRegenerateModal} onClose={() => setShowRegenerateModal(false)} onConfirm={confirmRegenerate} title="Regenerate Plan?" message="This will create a brand new set of tasks using AI. Your current progress will be lost. Are you sure?" confirmText="Yes, Regenerate" isDanger={false} />
                    <ConfirmationModal isOpen={!!stepToDelete} onClose={() => setStepToDelete(null)} onConfirm={confirmDeleteSubtask} title="Delete Step?" message="Are you sure you want to delete this step? This action cannot be undone." confirmText="Delete" isDanger={true} />
                    <AutoResetModal isOpen={showAutoResetModal} onClose={() => setShowAutoResetModal(false)} task={task} onSave={handleAutoResetSave} />
                </div>
            );
        };

        const App = () => {
            const [isDark, setIsDark] = useState(true);
            const [toast, setToast] = useState(null);
            const [user, setUser] = useState(() => { const saved = localStorage.getItem('keepup_user'); return saved ? JSON.parse(saved) : null; });
            const [tasks, setTasks] = useState(() => { const saved = localStorage.getItem('keepup_tasks'); return saved ? JSON.parse(saved) : []; });
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedTask, setSelectedTask] = useState(null);

            useEffect(() => {
                if (user) {
                    if (currentView === 'landing' || currentView === 'login') setCurrentView('dashboard');
                } else {
                    if (currentView !== 'landing' && currentView !== 'login') setCurrentView('landing');
                }
            }, [user]);

            useEffect(() => {
                if (isDark) { document.documentElement.classList.add('dark'); document.body.classList.remove('bg-gray-50', 'text-gray-900'); document.body.classList.add('bg-brand-dark', 'text-gray-100'); }
                else { document.documentElement.classList.remove('dark'); document.body.classList.remove('bg-brand-dark', 'text-gray-100'); document.body.classList.add('bg-gray-50', 'text-gray-900'); }
            }, [isDark]);

            useEffect(() => { if (user) localStorage.setItem('keepup_user', JSON.stringify(user)); else localStorage.removeItem('keepup_user'); }, [user]);
            useEffect(() => { localStorage.setItem('keepup_tasks', JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { const handleGlobalKeyDown = (e) => { const isSmartInput = e.target.id === 'smart-search-input'; if (e.key === 'Tab' && !isSmartInput) { e.preventDefault(); } }; window.addEventListener('keydown', handleGlobalKeyDown); return () => window.removeEventListener('keydown', handleGlobalKeyDown); }, []);

            const login = (type, accountData) => { 
                const newUser = { 
                    id: type === 'google' ? 'google_user_' + Date.now() : 'user_' + Date.now(), 
                    name: type === 'google' && accountData ? accountData.name : type === 'email' ? 'Demo User' : 'Guest User', 
                    email: type === 'google' && accountData ? accountData.email : type === 'email' ? 'demo@keepup.app' : null,
                    avatar: null, // Reset avatar on new login
                    xp: 0, 
                    level: 1, 
                    badges: [], 
                    type: type 
                };
                setUser(newUser); 
                setCurrentView('dashboard');
            };

            const logout = () => { setUser(null); setTasks([]); localStorage.removeItem('keepup_user'); localStorage.removeItem('keepup_tasks'); setCurrentView('landing'); };
            const addXP = (amount) => { setUser(prev => { const newXP = Math.max(0, prev.xp + amount); const newLevel = Math.floor(newXP / 100) + 1; return { ...prev, xp: newXP, level: newLevel }; }); };
            const updateUser = (userData) => { setUser(userData); };
            const addTask = (newTask) => { setTasks(prev => [newTask, ...prev]); if (newTask.description && newTask.description.includes("AI")) { setToast({ message: newTask.description.includes("Offline") ? "Plan generated (Offline)" : "Plan generated with AI!", type: "ai" }); } else { setToast({ message: "Task created successfully", type: "success" }); } };
            const deleteTask = (taskId) => { setTasks(prev => prev.filter(t => t.id !== taskId)); if (selectedTask?.id === taskId) { setSelectedTask(null); setCurrentView('dashboard'); } };
            
            // ... (Task Helper Functions: updateTaskSubtask, etc. remain the same)
            const updateTaskSubtask = (taskId, subtaskId, isDone) => {
                const getUpdatedTask = (t) => { const newSubtasks = t.subtasks.map(s => s.id === subtaskId ? { ...s, isDone } : s); const doneCount = newSubtasks.filter(s => s.isDone).length; const progress = Math.round((doneCount / newSubtasks.length) * 100); return { ...t, subtasks: newSubtasks, progress, status: progress === 100 ? 'completed' : 'active' }; };
                setTasks(prev => prev.map(t => t.id === taskId ? getUpdatedTask(t) : t));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return getUpdatedTask(prev); return prev; });
            };
            const deleteTaskSubtask = (taskId, subtaskId) => {
                const getUpdatedTask = (t) => { const newSubtasks = t.subtasks.filter(s => s.id !== subtaskId); const doneCount = newSubtasks.filter(s => s.isDone).length; const progress = newSubtasks.length > 0 ? Math.round((doneCount / newSubtasks.length) * 100) : 0; return { ...t, subtasks: newSubtasks, progress, status: progress === 100 ? 'completed' : 'active' }; };
                setTasks(prev => prev.map(t => t.id === taskId ? getUpdatedTask(t) : t));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return getUpdatedTask(prev); return prev; });
            };
            const editTaskSubtask = (taskId, subtaskId, newTitle) => {
                const getUpdatedTask = (t) => { const newSubtasks = t.subtasks.map(s => s.id === subtaskId ? { ...s, title: newTitle } : s); return { ...t, subtasks: newSubtasks }; };
                setTasks(prev => prev.map(t => t.id === taskId ? getUpdatedTask(t) : t));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return getUpdatedTask(prev); return prev; });
            };
            const addTaskSubtask = (taskId, title) => {
                const getUpdatedTask = (t) => { const newSubtask = { id: Date.now(), title: title, isDone: false, estimatedTime: '30m', tip: null }; const newSubtasks = [...t.subtasks, newSubtask]; const doneCount = newSubtasks.filter(s => s.isDone).length; const progress = newSubtasks.length > 0 ? Math.round((doneCount / newSubtasks.length) * 100) : 0; return { ...t, subtasks: newSubtasks, progress, status: progress === 100 ? 'completed' : 'active' }; };
                setTasks(prev => prev.map(t => t.id === taskId ? getUpdatedTask(t) : t));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return getUpdatedTask(prev); return prev; });
            };
            const updateSubtaskTip = (taskId, subtaskId, tip) => {
                const getUpdatedTask = (t) => { const newSubtasks = t.subtasks.map(s => s.id === subtaskId ? { ...s, tip: tip } : s); return { ...t, subtasks: newSubtasks }; };
                setTasks(prev => prev.map(t => t.id === taskId ? getUpdatedTask(t) : t));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return getUpdatedTask(prev); return prev; });
            };
            const resetTask = (taskId) => {
                const getResetTask = (t) => { return { ...t, status: 'active', progress: 0, autoReset: t.autoReset ? { ...t.autoReset, lastReset: new Date().toISOString() } : undefined, subtasks: t.subtasks.map(s => ({ ...s, isDone: false })) }; };
                setTasks(prev => prev.map(t => t.id === taskId ? getResetTask(t) : t));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return getResetTask(prev); return prev; });
            };
            const regenerateTask = (taskId, newSubtasks, newDescription) => {
                const getRegeneratedTask = (t) => ({ ...t, subtasks: newSubtasks, progress: 0, status: 'active', description: newDescription || `Plan regenerated on ${new Date().toLocaleDateString()}` });
                setTasks(prev => prev.map(t => t.id === taskId ? getRegeneratedTask(t) : t));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return getRegeneratedTask(prev); return prev; });
            };
            const updateTaskAutoReset = (taskId, config) => {
                setTasks(prev => prev.map(t => { if (t.id === taskId) return { ...t, autoReset: config }; return t; }));
                setSelectedTask(prev => { if (prev && prev.id === taskId) return { ...prev, autoReset: config }; return prev; });
            };

            useEffect(() => {
                const checkAutoResets = () => {
                    const now = new Date(); const currentHours = now.getHours(); const currentMinutes = now.getMinutes(); const todayStr = now.toDateString();
                    setTasks(prevTasks => {
                        let hasUpdates = false;
                        const updatedTasks = prevTasks.map(task => {
                            if (!task.autoReset || !task.autoReset.enabled) return task;
                            let shouldReset = false; const lastResetDate = new Date(task.autoReset.lastReset || 0);
                            if (task.autoReset.type === 'daily') { if (lastResetDate.toDateString() !== todayStr) { const [targetH, targetM] = task.autoReset.time.split(':').map(Number); if (currentHours > targetH || (currentHours === targetH && currentMinutes >= targetM)) { shouldReset = true; } } } else if (task.autoReset.type === 'interval') { const hoursDiff = (now - lastResetDate) / (1000 * 60 * 60); if (hoursDiff >= task.autoReset.intervalHours) { shouldReset = true; } }
                            if (shouldReset) { hasUpdates = true; return { ...task, status: 'active', progress: 0, autoReset: { ...task.autoReset, lastReset: now.toISOString() }, subtasks: task.subtasks.map(s => ({ ...s, isDone: false })) }; }
                            return task;
                        });
                        return hasUpdates ? updatedTasks : prevTasks;
                    });
                };
                const intervalId = setInterval(checkAutoResets, 60000); checkAutoResets(); return () => clearInterval(intervalId);
            }, []);

            return (
                <ThemeContext.Provider value={{ isDark, toggleTheme: () => setIsDark(!isDark) }}>
                    <AuthContext.Provider value={{ user, login, logout, addXP, updateUser }}>
                        <DataContext.Provider value={{ tasks, addTask, deleteTask, updateTaskSubtask, resetTask, regenerateTask, deleteTaskSubtask, editTaskSubtask, addTaskSubtask, updateTaskAutoReset, updateSubtaskTip }}>
                            <div className="min-h-screen smooth-transition relative isolate overflow-hidden">
                                {isDark && (
                                    <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
                                        <div className="absolute top-[-10%] left-[-20%] w-[700px] h-[700px] bg-brand-orange/10 rounded-full blur-[100px] animate-pulse-slow"></div>
                                        <div className="absolute top-[20%] right-[-10%] w-[600px] h-[600px] bg-indigo-900/20 rounded-full blur-[120px] animate-pulse-slow" style={{ animationDelay: '2s' }}></div>
                                        <div className="absolute bottom-[-10%] left-[20%] w-[500px] h-[500px] bg-blue-900/10 rounded-full blur-[100px] animate-pulse-slow" style={{ animationDelay: '4s' }}></div>
                                    </div>
                                )}
                                <div className="relative z-10">
                                    {currentView === 'landing' ? (
                                        <LandingPage onGetStarted={() => setCurrentView('login')} />
                                    ) : currentView === 'login' ? (
                                        <Login onLoginSuccess={login} onSwitchToGuest={() => login('guest')} />
                                    ) : (
                                        <>
                                            <Navbar onNavigate={setCurrentView} />
                                            <main>
                                                {currentView === 'dashboard' ? (
                                                    <Dashboard onTaskSelect={(t) => { setSelectedTask(t); setCurrentView('task-detail'); }} />
                                                ) : currentView === 'task-detail' ? (
                                                    <TaskDetail task={selectedTask} onBack={() => { setSelectedTask(null); setCurrentView('dashboard'); }} />
                                                ) : currentView === 'profile' ? (
                                                    <Profile onBack={() => setCurrentView('dashboard')} />
                                                ) : null}
                                            </main>
                                        </>
                                    )}
                                </div>
                                {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                            </div>
                        </DataContext.Provider>
                    </AuthContext.Provider>
                </ThemeContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
