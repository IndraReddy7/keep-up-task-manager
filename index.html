<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keep-up | AI Habit & Task Tracker</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            orange: '#f97316',
                            dark: '#0f0f0f',
                            card: '#1a1a1a',
                            hover: '#2a2a2a'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Smooth theme transition */
        body {
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .smooth-transition {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-duration: 500ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f97316; 
        }
    </style>
</head>
<body class="bg-brand-dark text-gray-100 antialiased selection:bg-brand-orange selection:text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;

        // --- Global Config ---
        const DEFAULT_API_KEY = "AIzaSyAyAFTze3RJtXnY_vxbILqUdsGXkMBS-aY"; 

        // --- Mock Data & Helpers ---
        const MOCK_SUGGESTIONS = [
            "Prepare for AWS Cloud Practitioner exam",
            "Lose 5 kg in 2 months",
            "Build a personal portfolio website",
            "Learn Spanish in 30 days",
            "Read 12 books this year",
            "Master React & TypeScript",
            "Train for a half-marathon"
        ];

        const EXAMPLE_PLANS = [
            { emoji: "ðŸ’»", text: "Learn React in 30 days" },
            { emoji: "ðŸƒ", text: "Train for a 5k run" },
            { emoji: "ðŸ ", text: "Declutter my apartment" },
            { emoji: "ðŸ“š", text: "Read 3 books this month" }
        ];

        // --- GEMINI API INTEGRATION ---
        const callGeminiPlanGenerator = async (goal, timeframe, aiMode = 'general') => {
            const apiKey = localStorage.getItem('keepup_gemini_key') || DEFAULT_API_KEY;
            
            if (!apiKey) {
                console.warn("No API Key found. Using mock generator.");
                return mockAIPlanGenerator(goal, timeframe);
            }

            let systemInstruction = "";
            if (aiMode === 'spoon-fed') {
                systemInstruction = `
                    You are an expert productivity coach known for "spoon-feeding" success. 
                    Your task is to break down the user's goal into extremely granular, simple, and specific steps.
                    Do not give broad advice like "Study chapter 1". Instead say "Open the book to page 1 and read the first paragraph".
                    Focus on micro-actions that reduce friction.
                `;
            } else if (aiMode === 'concise') {
                systemInstruction = `
                    You are a no-nonsense, efficiency-focused project manager.
                    Create a brief, high-level plan with only the essential milestones.
                    Keep steps short, direct, and limited to the most critical actions. Avoid fluff.
                `;
            } else {
                // General
                systemInstruction = `
                    You are a balanced and helpful productivity coach.
                    Create a structured, well-rounded plan with clear, actionable steps.
                    Provide a good mix of high-level guidance and specific actions suitable for a general audience.
                `;
            }

            const prompt = `
                ${systemInstruction}
                
                Goal: "${goal}"
                Timeframe: "${timeframe || 'flexible'}"
                
                Create a plan.
                Return ONLY a valid JSON object with this schema:
                {
                    "category": "One of [Study, Work, Fitness, Health, Personal, General]",
                    "steps": [
                        { "title": "Step title", "estimatedTime": "e.g. 15m or 1h" }
                    ]
                }
                Do not include markdown code blocks. Just the JSON.
            `;

            try {
                // Replaced external Gemini API call with internal backend endpoint
                const response = await fetch("/api/generate-plan", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ goal, timeframe, aiMode })
                });

                if (!response.ok) {
                    throw new Error("AI generation failed");
                }

                const aiResult = await response.json();

                return {
                    id: Date.now(),
                    title: goal,
                    description: `AI generated plan (${aiMode === 'spoon-fed' ? 'Spoon-fed' : aiMode === 'concise' ? 'Concise' : 'General'} Mode) âœ¨`,
                    createdAt: new Date().toISOString(),
                    targetEndDate: timeframe ? new Date(Date.now() + 30*24*60*60*1000).toISOString() : null,
                    status: 'active',
                    progress: 0,
                    category: aiResult.category || "General",
                    subtasks: (aiResult.steps || []).map((s, i) => ({
                        id: Date.now() + Math.random() + i,
                        title: s.title || s,
                        isDone: false,
                        estimatedTime: s.estimatedTime || ""
                    }))
                };

            } catch (error) {
                console.error("Gemini Error:", error);
                const fallbackPlan = await mockAIPlanGenerator(goal, timeframe);
                fallbackPlan.description = "Plan generated (Offline Mode)";
                return fallbackPlan;
            }
        };

        // --- Contexts ---
        const ThemeContext = createContext();
        const AuthContext = createContext();
        const DataContext = createContext();

        // --- Simulated Backend Logic (Fallback) ---
        const mockAIPlanGenerator = async (goal, timeframe) => {
             return new Promise((resolve) => {
                setTimeout(() => {
                    const lowerGoal = goal.toLowerCase();
                    let steps = [];
                    let category = "General";

                    if (lowerGoal.includes("aws") || lowerGoal.includes("cloud") || lowerGoal.includes("azure") || lowerGoal.includes("certification")) {
                        category = "Study";
                        steps = [
                            "Review official exam guide and domains",
                            "Complete a comprehensive video course (e.g., Udemy/Coursera)",
                            "Read whitepapers (Well-Architected Framework)",
                            "Take practice exams to identify weak areas",
                            "Review incorrect practice answers",
                            "Hands-on labs: Spin up EC2, S3, RDS",
                            "Final revision of key services (IAM, VPC)"
                        ];
                    }
                    else if (lowerGoal.includes("learn") || lowerGoal.includes("study")) {
                        category = "Study";
                        steps = [
                            "Research best resources (courses, docs, books)",
                            "Create a structured study roadmap",
                            "Complete the fundamentals module",
                            "Build a 'Hello World' or starter project",
                            "Practice with coding challenges",
                            "Deep dive into advanced concepts",
                            "Build a capstone project to verify skills"
                        ];
                    } else if (lowerGoal.includes("build") || lowerGoal.includes("create") || lowerGoal.includes("develop")) {
                        category = "Work";
                        steps = [
                            "Define core requirements and MVP features",
                            "Sketch UI wireframes and database schema",
                            "Set up development environment & repo",
                            "Implement core backend/logic",
                            "Build frontend user interface",
                            "Perform testing and bug fixing",
                            "Deploy application to production"
                        ];
                    } else if (lowerGoal.includes("fitness") || lowerGoal.includes("lose") || lowerGoal.includes("run")) {
                        category = "Fitness";
                        steps = [
                            "Define specific fitness targets (weight, distance)",
                            "Create a weekly workout schedule",
                            "Plan healthy meals & grocery list",
                            "Complete Week 1 workouts",
                            "Track progress (weight/measurements)",
                            "Adjust intensity for Week 2",
                            "Review monthly progress and rest"
                        ];
                    } else {
                        category = "General";
                        steps = [
                            `Research and define scope for "${goal}"`,
                            "Break down main goal into milestones",
                            "Gather necessary tools and resources",
                            "Complete the first major milestone",
                            "Review progress and adjust timeline",
                            "Execute final phase of tasks",
                            "Final review and completion"
                        ];
                    }

                    const subtasks = steps.map((step, i) => ({
                        id: Date.now() + Math.random() + i,
                        title: step,
                        isDone: false,
                        estimatedTime: `${Math.floor(Math.random() * 2) + 1}h`
                    }));

                    resolve({
                        id: Date.now(),
                        title: goal,
                        description: `Plan generated (Offline Mode)`,
                        createdAt: new Date().toISOString(),
                        targetEndDate: timeframe ? new Date(Date.now() + 30*24*60*60*1000).toISOString() : null,
                        status: 'active',
                        progress: 0,
                        category: category,
                        subtasks: subtasks
                    });
                }, 1200);
            });
        };

        // --- Components ---

        // 1. Icons
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                sun: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin=[...]
                moon: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="rou[...]
                layout: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="r[...]
                user: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="rou[...]
                logOut: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="r[...]
                search: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="r[...]
                checkCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejo[...]
                circle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="r[...]
                trash: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoi[...]
                edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="rou[...]
                arrowLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin[...]
                arrowRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoi[...]
                refresh: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="[...]
                rotateCcw: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin[...]
                sparkles: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLine[...]
                settings: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLine[...]
                x: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="r[...]
                plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin=[...]
                clock: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="ro[...]
                check: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoi[...]
                brain: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoi[...]
                zap: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin=[...]
                baby: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin=[...]
                camera: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejo[...]
                image: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoi[...]
                upload: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejo[...]
                chevronRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" stroke[...]
            };
            return icons[name] || null;
        };

        // 2. Custom Context Menu
        const CustomContextMenu = ({ x, y, onClose, onEdit, onDelete }) => {
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (menuRef.current && !menuRef.current.contains(e.target)) {
                        onClose();
                    }
                };
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, [onClose]);

            return (
                <div 
                    ref={menuRef}
                    className="fixed z-50 bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700 rounded-lg shadow-2xl overflow-hidden min-w-[160px] py-1 animate-fade-in text-gra[...]"
                    style={{ top: y, left: x }}
                >
                    <button 
                        onClick={onEdit}
                        className="w-full text-left px-4 py-3 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 transition-colors"
                    >
                        <Icon name="edit" size={14} /> Edit Task
                    </button>
                    <div className="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                    <button 
                        onClick={onDelete}
                        className="w-full text-left px-4 py-3 text-sm hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 dark:text-red-400 flex items-center gap-2 transition-colors"
                    >
                        <Icon name="trash" size={14} /> Delete Task
                    </button>
                </div>
            );
        };

        // 3. Smart Input
        const SmartInput = ({ onEnter }) => {
            const [inputValue, setInputValue] = useState("");
            const [suggestionIndex, setSuggestionIndex] = useState(0);
            const [tabPressCount, setTabPressCount] = useState(0);
            const [isFocused, setIsFocused] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [useAI, setUseAI] = useState(true);
            const inputRef = useRef(null);

            useEffect(() => {
                const interval = setInterval(() => {
                    setSuggestionIndex((prev) => (prev + 1) % MOCK_SUGGESTIONS.length);
                    if(!isFocused) setTabPressCount(0);
                }, 15000);
                return () => clearInterval(interval);
            }, [isFocused]);

            const handleSubmit = () => {
                if (inputValue.trim()) {
                    setIsLoading(true);
                    onEnter(inputValue, useAI).then(() => {
                        setIsLoading(false);
                        setInputValue("");
                        setTabPressCount(0);
                    });
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
                if (e.key === 'Tab') {
                    e.preventDefault(); 
                    if (inputValue.length > 0) return;
                    if (tabPressCount === 0) {
                        setTabPressCount(1);
                    } else {
                        setInputValue(MOCK_SUGGESTIONS[suggestionIndex]);
                        setTabPressCount(0);
                    }
                }
            };

            const activeSuggestion = MOCK_SUGGESTIONS[suggestionIndex];

            return (
                <div className="relative w-full max-w-2xl mx-auto mb-12 group z-10">
                    <div className={`absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none transition-colors duration-300 ${isFocused ? 'text-brand-orange' : 'text-gray-400 dark:te[...]`}
                    <Icon name="search" size={24} />
                    </div>
                    
                    <input
                        ref={inputRef}
                        type="text"
                        value={inputValue}
                        onChange={(e) => { setInputValue(e.target.value); setTabPressCount(0); }}
                        onFocus={() => setIsFocused(true)}
                        onBlur={() => { setIsFocused(false); setTabPressCount(0); }}
                        onKeyDown={handleKeyDown}
                        disabled={isLoading}
                        id="smart-search-input" 
                        className="w-full pl-14 pr-24 py-5 bg-white dark:bg-brand-card border border-gray-200 dark:border-gray-700/50 rounded-2xl focus:ring-2 focus:ring-brand-orange focus:border-tran[...]"
                        placeholder="What is your main goal?"
                    />

                    {!inputValue && (
                        <div className={`absolute inset-y-0 left-14 py-5 pointer-events-none text-gray-400 dark:text-gray-500 truncate flex items-center transition-opacity duration-300 ${isFocuse[...]`}
                            <span className="mr-3">{activeSuggestion}</span>
                            {isFocused && (
                                <span className={`text-[10px] px-1.5 py-0.5 rounded border border-gray-300 dark:border-gray-600 transition-colors ${tabPressCount === 1 ? 'bg-brand-orange text-whi[...]`}
                                    {tabPressCount === 1 ? "Press Tab again" : "Tab"}
                                </span>
                            )}
                        </div>
                    )}

                    <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                        {isLoading ? (
                            <div className="w-5 h-5 border-2 border-brand-orange border-t-transparent rounded-full animate-spin mr-2"></div>
                        ) : (
                            inputValue.trim() && (
                                <div className="flex items-center gap-1 animate-fade-in bg-gray-100 dark:bg-gray-800/50 rounded-lg p-1 border border-gray-200 dark:border-gray-700/50">
                                    <button
                                        onClick={() => setUseAI(!useAI)}
                                        className={`p-1.5 rounded-md transition-all duration-300 ${
                                            useAI 
                                            ? 'bg-brand-orange text-white shadow-sm' 
                                            : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'
                                        }`}
                                        title={useAI ? "AI Generation Enabled" : "Enable AI Generation"}
                                    >
                                        <Icon name="sparkles" size={18} className={useAI ? "fill-white" : ""} />
                                    </button>
                                    <div className="w-px h-4 bg-gray-300 dark:bg-gray-700 mx-1"></div>
                                    <button 
                                        onClick={handleSubmit}
                                        className="p-1.5 text-brand-orange hover:bg-brand-orange/10 rounded-md transition-all"
                                    >
                                        <Icon name="arrowRight" size={20} />
                                    </button>
                                </div>
                            )
                        )}
                    </div>
                </div>
            );
        };

        // ... rest of file unchanged (truncated for brevity in the commit content)
